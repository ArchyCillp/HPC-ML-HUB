### 3.1. Compilation with NVCC
- kernels -> PTX (汇编) -> cubin
- JIT编译：PTX在运行时被硬件编译成bin，这也是唯一能让应用在编译时没出现的硬件上跑的方法。
- cubin兼容性：8.2可以在8.6上跑，但是不能在7.x或者9.x或者8.0上跑
- PTX兼容性
- 应用兼容性：
	- - `-ptx`：生成PTX文件。
	- `-cubin`：生成CUBIN文件。
	- `-gencode`：可以同时生成PTX和CUBIN文件，支持多个架构。
	- `-arch`和`-code`：可以用来指定生成PTX和CUBIN文件的架构。
	- `-arch=sm_70`作为缩写，可以直接生成70的PTX和CUBIN

### 3.2 CUDA runtime
- cudart库，`libcudart.a`，`cudart.so`
#### 3.2.1 intialization
- 如果你没有显式调用`cudaSetDevice()`或`cudaInitDevice()`，CUDA运行时会隐式初始化device 0。
- 在测量时间之前，显式调用`cudaSetDevice()`或`cudaInitDevice()`，以确保初始化时间不会被计入后续API调用的时间测量中。
- 在应用程序的早期阶段显式调用`cudaSetDevice()`或`cudaInitDevice()`，并检查返回的错误代码，以确保CUDA运行时的正确初始化。
- primary context
	- `cudaSetDevice()`显式创建
	- 是在第一次调用CUDA runtime函数时隐式创建的
	- host端共享
	- `cudaDeviceReset()`用于销毁当前的primary context
	- 详见CUDA context章节
#### 3.2.2 device memory
- 两种类型
	- linear memory（常见）
	- CUDA arrays（Texture & surface memory）
- 拓展memory操作
	- cudaMallocPitch & cudaMalloc3D
		- 用于分配2D和3D数组，保证alignment
		- `cudaMallocPitch(&devPtr,&pitch,width*sizeof(float),height)`
		- devPtr是数组起始地址，pitch是每一行的bytes数量(padding过)，第三个是每一行的需求bytes，height是行的数量
		- pitch(或叫做stride)是一段连续的内存
	- symbol
		- `__device__`或者`__constant__`修饰的变量是device上global memory存放的变量，可以用`cudaMemcpyFromSymbol`, `cudaMemcpyToSymbol` 交互
#### 3.2.3 Device Memory L2 Access Management (CC 8.0)
- 数据访问频率
	- persisting: 频繁访问的数据
	- streaming: 只访问一次的数据
- 可以分配一部分(比如75%)L2 cache做set-aside L2 cache，用来自定义存放进L2 cache的数据
- MIG和MPS模式下，该功能不可用或者需要特殊设置
- 由于L2 set-aside是跨kernel共享的，所以分配时要考虑同时执行的所有kernel，L2是否够用
- accessPolicyWindow
	- 可用通过stream或者Graph指定一段global memory被L2 cache加速
	- hitRatio：
		- 如果写0.5，这段内存会有随机选取的50%放入L2 set-aside部分
		- 如果需要cache的区域比L2大，就只出现evict，保留最新访问的部分
		- 因为L2 cache是global的可以跨kernel，因此可以设置低hitRatio防止不同kernel之间相互evict。
	- cudaAccessProperty
		- Streaming：不入L2 cache
		- Persisting：尽量入L2 cache
			- Normal：默认，用于重置；注意如果不重置，kernel结束后可能还是会有内存处于persisting状态，从而影响后续使用，也可以用`cudaCtxResetPersistingL2Cache`来重置。
```C++
cudaStreamAttrValue stream_attribute;                  
stream_attribute.accessPolicyWindow.base_ptr  = reinterpret_cast<void*>(ptr); 
stream_attribute.accessPolicyWindow.num_bytes = num_bytes;     

stream_attribute.accessPolicyWindow.hitRatio  = 0.6;             
stream_attribute.accessPolicyWindow.hitProp   = cudaAccessPropertyPersisting;
stream_attribute.accessPolicyWindow.missProp  = cudaAccessPropertyStreaming; 

cudaStreamSetAttribute(stream, cudaStreamAttributeAccessPolicyWindow, &stream_attribute);
```

#### 3.2.4 Shared memory
- 最经典也是最重要的用shared memory优化gemm，要会默写[默写gemm](../gemm/默写gemm.md)

#### 3.2.5 Distributed Shared Memory (CC 9.0)
